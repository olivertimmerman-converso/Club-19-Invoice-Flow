<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Club 19 London - Invoice Flow</title>

  <!-- Clerk.js -->
  <script
    async
    crossorigin="anonymous"
    data-clerk-publishable-key="pk_live_Y2xlcmsuY29udmVyc28udWsk"
    data-clerk-frontend-api="clerk.converso.uk"
    src="https://clerk.converso.uk/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
  ></script>

  <!-- React + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-6px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn { animation: fadeIn 0.25s ease-out; }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .animate-spin { animation: spin 1s linear infinite; }
  </style>
</head>

<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">

/* --------------------------------------------------
      CLERK AUTHENTICATION & ALLOWED EMAILS
-------------------------------------------------- */
const CLERK_PUBLISHABLE_KEY = "pk_live_Y2xlcmsuY29udmVyc28udWsk";

const ALLOWED_EMAILS = [
  "sophie@club19london.com",
  "hope@club19london.com",
  "maryclair@club19london.com",
  "oliver@converso.uk",
  "alys@sketch24ltd.com"
];

/* --------------------------------------------------
      AUDIT LOGGING SYSTEM
-------------------------------------------------- */
const AUDIT_LOG_WEBHOOK = "https://hook.eu2.make.com/gmbtntgkxq7kagl456vblixfnn7jwgfd";

const logAuditEvent = async (eventType, eventData, user) => {
  try {
    const auditPayload = {
      eventType,
      timestamp: new Date().toISOString(),
      user: {
        email: user?.primaryEmailAddress?.emailAddress || "unknown",
        userId: user?.id || "unknown",
        firstName: user?.firstName || "",
        lastName: user?.lastName || ""
      },
      eventData,
      sessionId: user?.id + "_" + Date.now(),
      userAgent: navigator.userAgent,
      url: window.location.href
    };

    await fetch(AUDIT_LOG_WEBHOOK, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(auditPayload)
    });

    console.log(`[AUDIT] ${eventType}:`, auditPayload);
  } catch (error) {
    console.error("Audit logging failed:", error);
  }
};

/* --------------------------------------------------
      MAIN INVOICE COMPONENT
-------------------------------------------------- */
const { useState, useEffect, useRef } = React;

const InvoiceFlow = ({ clerk, user }) => {

  /* ---------------- STATE ---------------- */
  const [itemLocation, setItemLocation] = useState(null);
  const [clientLocation, setClientLocation] = useState(null);
  const [purchaseType, setPurchaseType] = useState(null);
  const [shippingOption, setShippingOption] = useState(null);
  const [directShip, setDirectShip] = useState(null);
  const [insuranceLanded, setInsuranceLanded] = useState(null);

  const [customerName, setCustomerName] = useState("");
  const [itemDescription, setItemDescription] = useState("");
  const [price, setPrice] = useState("");
  const [currency, setCurrency] = useState("GBP");
  const [dueDate, setDueDate] = useState("");

  const [dropdownResults, setDropdownResults] = useState([]);
  const [loadingCustomers, setLoadingCustomers] = useState(false);
  const [selectedIndex, setSelectedIndex] = useState(-1);
  const [isSearchActive, setIsSearchActive] = useState(false);
  const [errors, setErrors] = useState({});
  const [sending, setSending] = useState(false);
  const [copied, setCopied] = useState(false);

  const dropdownRef = useRef(null);
  const debounceTimer = useRef(null);

  /* --------------------------------------------------
          CUSTOMER SEARCH (Xero → Make webhook)
  -------------------------------------------------- */
  const fetchXeroContacts = async (query) => {
    try {
      setLoadingCustomers(true);
      const response = await fetch(
        "https://hook.eu2.make.com/knai3w9y6zsblc2kc1qu8j33cp4pwlhj",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query })
        }
      );
      const data = await response.json();
      setLoadingCustomers(false);
      return data.contacts || [];
    } catch (err) {
      console.error("Contact search error:", err);
      setLoadingCustomers(false);
      return [];
    }
  };

  const handleCustomerInput = (value) => {
    setCustomerName(value);
    setSelectedIndex(-1);
    setIsSearchActive(true);

    if (debounceTimer.current) clearTimeout(debounceTimer.current);

    if (value.length >= 2) {
      debounceTimer.current = setTimeout(async () => {
        const results = await fetchXeroContacts(value);
        setDropdownResults(results);
      }, 300);
    } else {
      setDropdownResults([]);
      setIsSearchActive(false);
    }
  };

  const selectCustomer = (c) => {
    setCustomerName(c.Name);
    setDropdownResults([]);
    setSelectedIndex(-1);
    setIsSearchActive(false);
  };

  /* --------------------------------------------------
          VALIDATION
  -------------------------------------------------- */
  const validateFields = () => {
    const newErrors = {};
    if (!customerName) newErrors.customerName = "Customer name is required.";
    if (!itemDescription) newErrors.itemDescription = "Item description is required.";
    if (!price) newErrors.price = "Price is required.";
    if (!dueDate) newErrors.dueDate = "Due date is required.";
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const isFormValid =
    customerName && itemDescription && price && dueDate;

  /* --------------------------------------------------
          TAX LOGIC (FULLY FIXED)
  -------------------------------------------------- */
  const getResult = () => {

  // Xero internal tax codes
  const TAX_20 = "OUTPUT2";              // 20% VAT on Income
  const TAX_ZERO = "ZERORATEDOUTPUT";    // Zero Rated Income 0%

  /* -----------------------------------------------
        UK Item → UK Client
  ----------------------------------------------- */
  if (itemLocation === "uk" && clientLocation && purchaseType) {
    const scenarios = {
      "uk-retail": {
        taxLiability:
          "Full price of item including VAT on first line\n+ Service Fee on second line",
        brandTheme: "CN 20% VAT",
        amountsAre: "Inclusive",
        accountCode: "425",
        taxType: TAX_20,
        taxLabel: "20% VAT on Income",
        vatReclaim: "Business reclaims VAT from original purchase"
      },

      "uk-margin": {
        taxLiability: "Item is purchased on UK margin rule",
        brandTheme: "CN Margin Scheme",
        amountsAre: "Inclusive",
        accountCode: "424",
        taxType: TAX_ZERO,
        taxLabel: "Zero Rated Income 0%",
        vatReclaim: "None"
      },

      "outside-retail": {
        taxLiability:
          "Full price of item including VAT on first line\n+ Service Fee on second line",
        brandTheme: "CN Export Sales",
        amountsAre: "Exclusive",
        accountCode: "423",
        taxType: TAX_ZERO,
        taxLabel: "Zero Rated Income 0%",
        vatReclaim: "Business reclaims VAT from original purchase"
      },

      "outside-margin": {
        taxLiability: "Item is purchased on UK margin rule",
        brandTheme: "CN Export Sales",
        amountsAre: "Exclusive",
        accountCode: "423",
        taxType: TAX_ZERO,
        taxLabel: "Zero Rated Income 0%",
        vatReclaim: "None"
      }
    };

    return scenarios[`${clientLocation}-${purchaseType}`];
  }

  /* -----------------------------------------------
        Item Outside → UK Client
  ----------------------------------------------- */
  if (itemLocation === "outside" && clientLocation === "uk") {

    // Cannot ship OR cannot direct ship
    if (
      shippingOption === "no" ||
      (shippingOption === "yes" && directShip === "no")
    ) {
      return {
        taxLiability: "Full VAT needs adding to Cost and Sale Price",
        note: "Item needs to come to UK",
        brandTheme: "CN 20% VAT",
        amountsAre: "Inclusive",
        accountCode: "425",
        taxType: TAX_20,
        taxLabel: "20% VAT on Income",
        vatReclaim: "None"
      };
    }

    // Shipping allowed AND direct ship
    if (shippingOption === "yes" && directShip === "yes" && insuranceLanded) {
      const landed = insuranceLanded === "yes";

      return {
        taxLiability: landed
          ? "No liability, provide client item price plus margin plus delivery"
          : "Full VAT needs adding to Cost and Sale Price",
        note: landed ? null : "Item needs to come to UK",
        brandTheme: landed ? "CN Export Sales" : "CN 20% VAT",
        amountsAre: "Inclusive",
        accountCode: landed ? "423" : "425",
        taxType: landed ? TAX_ZERO : TAX_20,
        taxLabel: landed ? "Zero Rated Income 0%" : "20% VAT on Income",
        vatReclaim: "None"
      };
    }
  }

  /* -----------------------------------------------
        Outside → Outside (export)
  ----------------------------------------------- */
  if (itemLocation === "outside" && clientLocation === "outside") {
    return {
      taxLiability:
        "No liability, provide client item price plus margin plus delivery",
      brandTheme: "CN Export Sales",
      amountsAre: "Inclusive",
      accountCode: "423",
      taxType: TAX_ZERO,
      taxLabel: "Zero Rated Income 0%",
      vatReclaim: "None"
    };
  }

  return null;
};


  const result = getResult();

  /* --------------------------------------------------
          SEND TO XERO (Make Webhook)
  -------------------------------------------------- */
  const sendToXero = async () => {
    if (!result) {
      alert("Please complete invoice setup first.");
      return;
    }

    if (!validateFields()) return;

    setSending(true);

    // Map UI values to Xero's LineAmountTypes API values
    const lineAmountTypeMap = {
      "Inclusive": "Inclusive",
      "Exclusive": "Exclusive",
      "No tax": "NoTax",
      "NoTax": "NoTax",
      "None": "NoTax"
    };

    const invoiceData = {
      accountCode: result.accountCode,

      // FIX: Xero must receive taxType only (OUTPUT2 or ZERORATEDOUTPUT)
      taxType: result.taxType,

      // FIX: Include taxLabel only for human readability in Make (NOT used by Xero)
      taxLabel: result.taxLabel,

      brandTheme: result.brandTheme,
      amountsAre: result.amountsAre,

      // LineAmountTypes field for Xero API
      lineAmountTypes: lineAmountTypeMap[result.amountsAre],

      taxLiability: result.taxLiability,
      vatReclaim: result.vatReclaim,
      customerName,
      itemDescription,
      price: parseFloat(price),
      currency,
      dueDate,
      timestamp: new Date().toISOString()
    };

    try {
      // Log invoice creation attempt
      await logAuditEvent("INVOICE_CREATE_ATTEMPT", {
        customerName,
        itemDescription,
        price: parseFloat(price),
        currency,
        dueDate,
        accountCode: result.accountCode,
        taxType: result.taxType,
        brandTheme: result.brandTheme
      }, user);

      const resp = await fetch(
        "https://hook.eu2.make.com/6yd7c1j1we7wzujw7vdne6cr6wd8jp9b",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(invoiceData)
        }
      );

      if (!resp.ok) throw new Error("Xero creation failed");

      // Log successful invoice creation
      await logAuditEvent("INVOICE_CREATE_SUCCESS", {
        customerName,
        itemDescription,
        price: parseFloat(price),
        currency,
        accountCode: result.accountCode
      }, user);

      alert("Invoice created successfully in Xero!");
      setSending(false);

    } catch (err) {
      // Log invoice creation failure
      await logAuditEvent("INVOICE_CREATE_FAILURE", {
        customerName,
        error: err.message
      }, user);

      alert("Error: " + err.message);
      setSending(false);
    }
  };

  /* --------------------------------------------------
          LOGOUT HANDLER
  -------------------------------------------------- */
  const handleLogout = async () => {
    await logAuditEvent("USER_LOGOUT", {
      logoutTime: new Date().toISOString()
    }, user);

    await clerk.signOut();
    window.location.reload();
  };

  /* --------------------------------------------------
          RESET FORM
  -------------------------------------------------- */
  const reset = () => {
    setItemLocation(null);
    setClientLocation(null);
    setPurchaseType(null);
    setShippingOption(null);
    setDirectShip(null);
    setInsuranceLanded(null);
    setCustomerName("");
    setPrice("");
    setItemDescription("");
    setCurrency("GBP");
    setDueDate("");
    setDropdownResults([]);
    setErrors({});
    setSelectedIndex(-1);
    setIsSearchActive(false);
  };

  /* --------------------------------------------------
          UI RENDER
  -------------------------------------------------- */
  return (
    <div className="max-w-xl mx-auto py-8 px-4">

      {/* HEADER */}
      <div className="bg-black text-white p-6 rounded-lg shadow mb-6">
        <div className="flex justify-between items-start">
          <div className="flex-1 text-center">
            <div className="font-serif tracking-widest text-2xl">
              CLUB<span className="text-3xl">19</span>
            </div>
            <div className="font-serif tracking-widest text-sm">LONDON</div>
          </div>
          <button
            onClick={handleLogout}
            className="text-xs bg-white text-black px-3 py-1 rounded hover:bg-gray-200 transition"
          >
            Logout
          </button>
        </div>
        <div className="border-t border-gray-600 mt-4 pt-3 text-center text-lg">
          Invoice Flow
        </div>
        <div className="text-center text-xs text-gray-400 mt-2">
          Logged in as {user.primaryEmailAddress?.emailAddress}
        </div>
      </div>

      {/* STEP 1 */}
      <div className="bg-white p-4 rounded-lg shadow mb-4">
        <h2 className="font-semibold mb-3">1. Where is the item?</h2>
        <button
          className={`w-full p-3 border rounded mb-2 ${
            itemLocation === "uk" ? "border-black bg-gray-100" : "border-gray-300"
          }`}
          onClick={() => {
            setItemLocation("uk");
            setClientLocation(null);
            setPurchaseType(null);
            setShippingOption(null);
            setDirectShip(null);
            setInsuranceLanded(null);
          }}
        >
          Item is in UK
        </button>

        <button
          className={`w-full p-3 border rounded ${
            itemLocation === "outside"
              ? "border-black bg-gray-100"
              : "border-gray-300"
          }`}
          onClick={() => {
            setItemLocation("outside");
            setClientLocation(null);
            setPurchaseType(null);
            setShippingOption(null);
            setDirectShip(null);
            setInsuranceLanded(null);
          }}
        >
          Item is outside UK
        </button>
      </div>

      {/* STEP 2 */}
      {itemLocation && (
        <div className="bg-white p-4 rounded-lg shadow mb-4 animate-fadeIn">
          <h2 className="font-semibold mb-3">2. Where is the client?</h2>

          <button
            className={`w-full p-3 border rounded mb-2 ${
              clientLocation === "uk"
                ? "border-black bg-gray-100"
                : "border-gray-300"
            }`}
            onClick={() => {
              setClientLocation("uk");
              setPurchaseType(null);
              setShippingOption(null);
              setDirectShip(null);
              setInsuranceLanded(null);
            }}
          >
            Client is in UK
          </button>

          <button
            className={`w-full p-3 border rounded ${
              clientLocation === "outside"
                ? "border-black bg-gray-100"
                : "border-gray-300"
            }`}
            onClick={() => {
              setClientLocation("outside");
              setPurchaseType(null);
              setShippingOption(null);
              setDirectShip(null);
              setInsuranceLanded(null);
            }}
          >
            Client is outside UK
          </button>
        </div>
      )}

      {/* STEP 3 — UK purchase type */}
      {itemLocation === "uk" && clientLocation && (
        <div className="bg-white p-4 rounded-lg shadow mb-4 animate-fadeIn">
          <h2 className="font-semibold mb-3">3. How is the item purchased?</h2>

          <button
            onClick={() => setPurchaseType("retail")}
            className={`w-full p-3 border rounded mb-2 ${
              purchaseType === "retail" ? "border-black bg-gray-100" : "border-gray-300"
            }`}
          >
            From retail store
          </button>

          <button
            onClick={() => setPurchaseType("margin")}
            className={`w-full p-3 border rounded ${
              purchaseType === "margin" ? "border-black bg-gray-100" : "border-gray-300"
            }`}
          >
            On UK margin rule
          </button>
        </div>
      )}

      {/* STEP 3 — Outside → UK shipping */}
      {itemLocation === "outside" && clientLocation === "uk" && (
        <div className="bg-white p-4 rounded-lg shadow mb-4 animate-fadeIn">
          <h2 className="font-semibold mb-3">3. Can client ship to other countries?</h2>

          <button
            onClick={() => {
              setShippingOption("no");
              setDirectShip(null);
              setInsuranceLanded(null);
            }}
            className={`w-full p-3 border rounded mb-2 ${
              shippingOption === "no" ? "border-black bg-gray-100" : "border-gray-300"
            }`}
          >
            No
          </button>

          <button
            onClick={() => {
              setShippingOption("yes");
              setDirectShip(null);
              setInsuranceLanded(null);
            }}
            className={`w-full p-3 border rounded ${
              shippingOption === "yes" ? "border-black bg-gray-100" : "border-gray-300"
            }`}
          >
            Yes
          </button>
        </div>
      )}

      {/* STEP 4 — Direct ship */}
      {shippingOption === "yes" &&
        itemLocation === "outside" &&
        clientLocation === "uk" && (
          <div className="bg-white p-4 rounded-lg shadow mb-4 animate-fadeIn">
            <h2 className="font-semibold mb-3">
              4. Can supplier ship directly to client?
            </h2>

            <button
              onClick={() => {
                setDirectShip("no");
                setInsuranceLanded(null);
              }}
              className={`w-full p-3 border rounded mb-2 ${
                directShip === "no" ? "border-black bg-gray-100" : "border-gray-300"
              }`}
            >
              No
            </button>

            <button
              onClick={() => {
                setDirectShip("yes");
                setInsuranceLanded(null);
              }}
              className={`w-full p-3 border rounded ${
                directShip === "yes" ? "border-black bg-gray-100" : "border-gray-300"
              }`}
            >
              Yes
            </button>
          </div>
        )}

      {/* STEP 5 — Insurance / landed cost */}
      {directShip === "yes" &&
        itemLocation === "outside" &&
        clientLocation === "uk" &&
        shippingOption === "yes" && (
          <div className="bg-white p-4 rounded-lg shadow mb-4 animate-fadeIn">
            <h2 className="font-semibold mb-3">
              5. Can supplier provide full insurance & landed cost?
            </h2>

            <button
              onClick={() => setInsuranceLanded("no")}
              className={`w-full p-3 border rounded mb-2 ${
                insuranceLanded === "no"
                  ? "border-black bg-gray-100"
                  : "border-gray-300"
              }`}
            >
              No
            </button>

            <button
              onClick={() => setInsuranceLanded("yes")}
              className={`w-full p-3 border rounded ${
                insuranceLanded === "yes"
                  ? "border-black bg-gray-100"
                  : "border-gray-300"
              }`}
            >
              Yes
            </button>
          </div>
        )}

      {/* FINAL SETTINGS PANEL */}
      {result && (
        <div className="bg-gray-100 border-t-4 border-black p-4 rounded-lg shadow animate-fadeIn mb-6">

          <h3 className="font-bold text-lg mb-3">Invoice Settings</h3>

          <div className="space-y-4">

            {/* Invoice Item Line Detail */}
            <div className="bg-white border p-3 rounded shadow-sm">
              <div className="text-xs font-semibold uppercase text-gray-500 mb-1">
                Invoice Item Line Detail
              </div>
              <div className="font-medium whitespace-pre-line">
                {result.taxLiability}
              </div>
              {result.note && (
                <div className="text-sm text-amber-700 mt-2 italic">{result.note}</div>
              )}
            </div>

            {/* Brand Theme */}
            <div className="bg-white border p-3 rounded shadow-sm">
              <div className="text-xs font-semibold uppercase text-gray-500 mb-1">
                Brand Theme
              </div>
              <div className="font-medium">{result.brandTheme}</div>
            </div>

            {/* Amounts Are */}
            <div className="bg-white border p-3 rounded shadow-sm">
              <div className="text-xs font-semibold uppercase text-gray-500 mb-1">
                Amounts Are
              </div>
              <div className="font-medium">{result.amountsAre}</div>
            </div>

            {/* Account Code */}
            <div className="bg-white border p-3 rounded shadow-sm">
              <div className="text-xs font-semibold uppercase text-gray-500 mb-1">
                Account Code
              </div>
              <div className="font-medium text-xl">{result.accountCode}</div>
            </div>

            {/* Xero Tax Code */}
            <div className="bg-white border p-3 rounded shadow-sm">
              <div className="text-xs font-semibold uppercase text-gray-500 mb-1">
                Xero Tax Code
              </div>
              <div className="font-medium">{result.taxType}</div>
            </div>

            {/* Friendly Tax Description */}
            <div className="bg-white border p-3 rounded shadow-sm">
              <div className="text-xs font-semibold uppercase text-gray-500 mb-1">
                Friendly Tax Description
              </div>
              <div className="font-medium">{result.taxLabel}</div>
            </div>

            {/* VAT Reclaim */}
            <div className="bg-white border p-3 rounded shadow-sm">
              <div className="text-xs font-semibold uppercase text-gray-500 mb-1">
                VAT Reclaim
              </div>
              <div className="font-medium">{result.vatReclaim}</div>
            </div>

          </div>

          {/* INVOICE DETAILS FORM */}
          <div className="mt-6 border-t pt-4">
            <h3 className="font-bold text-lg mb-3">Invoice Details</h3>

            {/* Customer Name */}
            <div className="mb-4" ref={dropdownRef}>
              <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">
                Customer Name
              </label>

              <div className="relative">
                <input
                  className="w-full p-3 border-2 rounded focus:outline-none focus:border-black"
                  value={customerName}
                  placeholder="Start typing customer name…"
                  onChange={(e) => handleCustomerInput(e.target.value)}
                  onKeyDown={(e) => {
                    if (!dropdownResults.length) return;

                    if (e.key === "ArrowDown") {
                      e.preventDefault();
                      setSelectedIndex((i) =>
                        i < dropdownResults.length - 1 ? i + 1 : i
                      );
                    }

                    if (e.key === "ArrowUp") {
                      e.preventDefault();
                      setSelectedIndex((i) => (i > 0 ? i - 1 : 0));
                    }

                    if (e.key === "Enter" && selectedIndex >= 0) {
                      e.preventDefault();
                      selectCustomer(dropdownResults[selectedIndex]);
                    }

                    if (e.key === "Escape") {
                      setDropdownResults([]);
                      setIsSearchActive(false);
                    }
                  }}
                />

                {loadingCustomers && (
                  <div className="absolute right-3 top-1/2 -translate-y-1/2">
                    <div className="w-4 h-4 border-2 border-black border-t-transparent rounded-full animate-spin"></div>
                  </div>
                )}

                {dropdownResults.length > 0 && (
                  <ul className="absolute z-10 mt-1 bg-white border-2 border-black rounded-lg max-h-48 overflow-auto w-full shadow">
                    {dropdownResults.map((c, i) => (
                      <li
                        key={i}
                        className={`p-3 cursor-pointer ${
                          selectedIndex === i
                            ? "bg-black text-white"
                            : "hover:bg-gray-200"
                        }`}
                        onClick={() => selectCustomer(c)}
                        onMouseEnter={() => setSelectedIndex(i)}
                      >
                        {c.Name}
                      </li>
                    ))}
                  </ul>
                )}
              </div>

              {errors.customerName && (
                <p className="text-red-600 text-sm mt-1">{errors.customerName}</p>
              )}
            </div>

            {/* Item Description */}
            <div className="mb-4">
              <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">
                Item Description
              </label>
              <input
                className="w-full p-3 border-2 rounded focus:outline-none focus:border-black"
                value={itemDescription}
                onChange={(e) => setItemDescription(e.target.value)}
              />
              {errors.itemDescription && (
                <p className="text-red-600 text-sm mt-1">{errors.itemDescription}</p>
              )}
            </div>

            {/* Price */}
            <div className="mb-4">
              <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">
                Price
              </label>

              <div className="flex gap-2">
                <select
                  className="p-3 border-2 rounded bg-white focus:border-black"
                  value={currency}
                  onChange={(e) => setCurrency(e.target.value)}
                >
                  <option value="GBP">£ GBP</option>
                  <option value="USD">$ USD</option>
                  <option value="EUR">€ EUR</option>
                  <option value="CHF">CHF</option>
                  <option value="JPY">¥ JPY</option>
                </select>

                <input
                  type="number"
                  step="0.01"
                  min="0"
                  className="flex-1 p-3 border-2 rounded focus:outline-none focus:border-black"
                  value={price}
                  onChange={(e) => setPrice(e.target.value)}
                />
              </div>

              {errors.price && <p className="text-red-600 text-sm mt-1">{errors.price}</p>}
            </div>

            {/* Due Date */}
            <div className="mb-4">
              <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">
                Due Date
              </label>
              <input
                type="date"
                className="w-full p-3 border-2 rounded focus:outline-none focus:border-black"
                value={dueDate}
                onChange={(e) => setDueDate(e.target.value)}
              />
              {errors.dueDate && <p className="text-red-600 text-sm mt-1">{errors.dueDate}</p>}
            </div>
          </div>

          {/* Buttons */}
          <button
            onClick={sendToXero}
            disabled={sending || !isFormValid}
            className={`w-full mt-4 p-3 rounded font-medium flex justify-center items-center ${
              sending || !isFormValid
                ? "bg-gray-400 text-gray-200"
                : "bg-green-600 text-white hover:bg-green-700"
            }`}
          >
            {sending ? (
              <>
                <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></div>
                Sending…
              </>
            ) : (
              "Create Invoice in Xero"
            )}
          </button>

          <button
            onClick={reset}
            className="w-full mt-2 p-3 rounded font-medium bg-black text-white hover:bg-gray-800"
          >
            Start Over
          </button>
        </div>
      )}
    </div>
  );
};

/* --------------------------------------------------
      ACCESS DENIED COMPONENT
-------------------------------------------------- */
const AccessDenied = ({ clerk, userEmail }) => {
  const handleLogout = async () => {
    await clerk.signOut();
    window.location.reload();
  };

  return (
    <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
      <div className="max-w-md w-full bg-white rounded-lg shadow-lg p-8 text-center">
        <div className="mb-6">
          <div className="font-serif tracking-widest text-3xl mb-2">
            CLUB<span className="text-4xl">19</span>
          </div>
          <div className="font-serif tracking-widest text-sm">LONDON</div>
        </div>

        <div className="mb-6">
          <svg className="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <h2 className="text-2xl font-bold text-gray-800 mb-2">Access Denied</h2>
          <p className="text-gray-600 mb-4">
            You do not have access to this application.
          </p>
          <p className="text-sm text-gray-500">
            Logged in as: <span className="font-mono">{userEmail}</span>
          </p>
        </div>

        <button
          onClick={handleLogout}
          className="w-full bg-black text-white py-3 px-4 rounded font-medium hover:bg-gray-800 transition"
        >
          Sign Out
        </button>
      </div>
    </div>
  );
};

/* --------------------------------------------------
      AUTH WRAPPER & APP INITIALIZATION
-------------------------------------------------- */
const App = () => {
  const [loading, setLoading] = useState(true);
  const [clerk, setClerk] = useState(null);
  const [user, setUser] = useState(null);
  const [isAllowed, setIsAllowed] = useState(false);

  useEffect(() => {
    const init = async () => {
      try {
        await window.Clerk.load();
        const user = window.Clerk.user;
        setClerk(window.Clerk);
        setUser(user);

        if (user) {
          const email = user.primaryEmailAddress?.emailAddress;
          setIsAllowed(ALLOWED_EMAILS.includes(email));

          // Log user authentication event
          const allowed = ALLOWED_EMAILS.includes(email);
          if (allowed) {
            await logAuditEvent("USER_LOGIN_SUCCESS", {
              loginTime: new Date().toISOString(),
              accessGranted: true
            }, user);
          } else {
            await logAuditEvent("USER_LOGIN_DENIED", {
              loginTime: new Date().toISOString(),
              accessGranted: false,
              reason: "Email not in allowed list"
            }, user);
          }
        }

        setLoading(false);
      } catch (err) {
        console.error("Clerk failed to load:", err);
        setLoading(false);
      }
    };

    init();
  }, []);

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="w-16 h-16 border-4 border-black border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-gray-600">Loading...</p>
        </div>
      </div>
    );
  }

  if (!clerk) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center text-red-600">
          <p>Failed to load authentication. Please refresh the page.</p>
        </div>
      </div>
    );
  }

  if (!user) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
        <div className="max-w-md w-full bg-white rounded-lg shadow-lg p-8">
          <div className="text-center mb-6">
            <div className="font-serif tracking-widest text-3xl mb-2">
              CLUB<span className="text-4xl">19</span>
            </div>
            <div className="font-serif tracking-widest text-sm mb-4">LONDON</div>
            <h2 className="text-2xl font-bold text-gray-800 mb-2">Invoice Flow</h2>
            <p className="text-gray-600">Please sign in to continue</p>
          </div>
          <div id="clerk-signin"></div>
        </div>
      </div>
    );
  }

  if (!isAllowed) {
    return <AccessDenied clerk={clerk} userEmail={user.primaryEmailAddress?.emailAddress} />;
  }

  return <InvoiceFlow clerk={clerk} user={user} />;
};

/* --------------------------------------------------
      RENDER APP WITH CLERK SIGN-IN
-------------------------------------------------- */
const renderApp = async () => {
  const rootElement = document.getElementById("root");
  ReactDOM.render(<App />, rootElement);

  // Mount Clerk SignIn component if needed
  const checkAndMountSignIn = setInterval(() => {
    const signInContainer = document.getElementById("clerk-signin");
    if (signInContainer && window.Clerk) {
      window.Clerk.load().then(() => {
        window.Clerk.mountSignIn(signInContainer, {
          appearance: {
            elements: {
              rootBox: "w-full",
              card: "shadow-none"
            }
          },
          signUpUrl: false // Disable sign up, only allow sign in
        });
      });
      clearInterval(checkAndMountSignIn);
    }
  }, 100);
};

renderApp();

  </script>
</body>
</html>